<?php

session_start();
?>

<!DOCTYPE html>
<html lang="en">
<head>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="tyyli.css">
    <meta charset="UTF-8">
    <title>Lataa Tiedot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    @import url("https://use.typekit.net/xfa2oxy.css");
    ::placeholder {
        color: #a8a7a7;
        font-family: "Gopher", sans-serif;
        font-weight: 400;
        font-style: normal;
        opacity: 1; /* Firefox */
    }

    :-ms-input-placeholder { /* Internet Explorer 10-11 */
        color: #a8a7a7;
        font-family: "Gopher", sans-serif;
        font-weight: 400;
        font-style: normal;
    }

    ::-ms-input-placeholder { /* Microsoft Edge */
        color: #a8a7a7;
        font-family: "Gopher", sans-serif;
        font-weight: 400;
        font-style: normal;
    }
</style>
</head>

<ul class="navbar">
    <li>
        <a class="nav-link" href=index.html >Sähkölisko</a></li>
    <li style="float:right">
        <a onclick="document.getElementById('id01').style.display='block'">Kirjaudu</a></li>
    <li style="float:right">
        <a class="nav-link" href=rekisteröityminen.html >Rekisteröidy</a></li>
</ul>

<div id="id01" class="modal">
    <form class="modal-content animate" action="kirjautuminen.php" method="post">
        <div class="imgcontainer">
            <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal">&times;</span>
        </div>

        <div class="container">
            <h1> Tervetuloa takaisin</h1>
            <p>Kirjaudu sisään jatkaaksesi.</p>
            <label for="mail"><b>Sähköpostiosoite</b><br></label>
            <input type="text" placeholder="Syötä sähköpostiosoite" name="mail" required>

            <label for="psw"><b>Salasana</b></label>
            <input type="password" placeholder="Syötä salasana" name="psw" required>

            <button type="submit">Kirjaudu</button>
            <label>
                <input type="checkbox" checked="checked" name="remember"> Muista minut
            </label>

            <button class="button button2" type="button" onclick="document.getElementById('id01').style.display='none'" class="cancelbtn">Peruuta</button>
            <span class="psw"> <a href="rekisteröityminen.html">Rekisteröidy</a></span>
        </div>
    </form>
</div>

<div class="container1">
    <h1>Seuraa ja ymmärrä omaa sähkönkulutustasi.</h1>
    <p>Saat valmiin csv-tiedoston ladattua <a href="https://oma.datahub.fi/#/login?returnUrl=%2F">tästä linkistä</a>.</p>

    <button class="button button2" onclick="openModal()">Ohjeet</button>

    <div id="myModal" class="modal">
        <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Ohjeet</h2>
        <p>Hae datahub:ista oma sähkönkulutuksesi. Tallenna csv-tiedosto esimerkiksi työpöydällesi. Lataa sen jälkeen tiedosto Lataa tiedosto-painikkeen kautta.</p>
        </div>
    </div>


    <script>

    function openModal() {
        document.getElementById("myModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("myModal").style.display = "none";
    }
</script>

<script>
    var data = [];
    var labels = [];
    var yLabel = "";


    function Upload() {
        var fileUpload = document.getElementById("fileUpload");
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
        if (regex.test(fileUpload.value.toLowerCase())) {
            if (typeof FileReader != "undefined") {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var rows = e.target.result.split("\n");
                    this.labels = labels;
                    this.data = data;
                    this.yLabel = yLabel;
                    var yearlyConsumption = 0; // Alustetaan vuosikulutus nollaksi
                    for (var i = 1; i < rows.length; i++) {
                        var cells = rows[i].split(";");
                        if (cells.length > 1) {
                            var date = new Date(cells[5].slice(0, -1));
                            var formattedDate = date.getDate() + "." + (date.getMonth() + 1) + "." + date.getFullYear() + " klo " + date.getHours() + "." + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
                            labels.push(formattedDate);
                            var consumption = parseFloat(cells[6].replace(",", "."));
                            data.push(consumption);
                            yLabel = cells[3];
                            yearlyConsumption += consumption; // Lisätään kulutus vuosikulutukseen
                        }
                    }
                    yearlyConsumption *= 24 * 365 / data.length; // Karkea arvio vuosikulutuksesta saatavilla olevan datan perusteella
                    var apartmentType;
                    if (yearlyConsumption >= 1000 && yearlyConsumption < 1800) {
                        apartmentType = "yksiö";
                    } else if (yearlyConsumption >= 1800 && yearlyConsumption < 2200) {
                        apartmentType = "kaksio";
                    } else if (yearlyConsumption >= 2200 && yearlyConsumption < 2800) {
                        apartmentType = "kolmio";
                    } else {
                        apartmentType = "jokin muu";
                    }

                    var ctx = document.getElementById("myChart").getContext("2d");
                    myChart = new Chart(ctx, {
                        type: "line",
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Kulutus (" + yLabel + ")",
                                    data: data,
                                    borderColor: "rgb(49,41,54, 0.5)",
                                    backgroundColor: "rgb(49,41,54, 0.2)",
                                    borderWidth: 2,
                                    pointRadius: 2,
                                    hoverRadius:5,
                                    pointBackgroundColor: "rgb(49,41,54)",
                                    pointBorderColor: "rgb(49,41,54)",
                                    fill: true

                                }
                            ]
                        },
                        options: {
                            scales: {
                                y: {
                                    title: {
                                        display: true,
                                        text: yLabel,
                                        font: {
                                            family: "Gopher",
                                            weight: "bold"
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            family: "Gopher",
                                        }
                                    },
                                    beginAtZero: true
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Aika',
                                        font: {
                                            family: "Gopher",
                                            weight: "bold"
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            family: "Gopher",
                                        }
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: ' Arvio vuosikulutuksesta: ' + yearlyConsumption.toFixed(2) +"kWh" + " " + apartmentType,

                                    font: {
                                        family: 'Gopher',
                                        weight: 'bold',
                                        size: 24
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 30
                                    }
                                },
                                legend: {
                                    labels: {
                                        font: {
                                            family: "Gopher",
                                            weight: "bold"
                                        }
                                    }
                                }
                            }
                        }
                    });


                    // Painikkeet näkyviin vasta kaavion muodostumisen jälkeen
                    document.getElementById("buttonContainer").classList.remove("hidden");
                    // Näytä kyselyn kehotus ja painike
                    document.getElementById("surveyPrompt").style.display = "block";
                    document.getElementById("surveyButton").style.display = "block";
                    document.getElementById("sidebar").style.display = "block";
                };
                reader.readAsText(fileUpload.files[0]);
            }  else {
                alert("This browser does not support HTML5.");
            }
        } else {
            alert("Please upload a valid CSV file.");
        }
    }
    document.getElementById("fileUpload").addEventListener("change", Upload);
    function updateFilteredChart() {
        // Laske suurin 15% kulutus
        var maxConsumption = Math.max(...data) * 0.3;

        var filteredData = [];
        var filteredLabels = [];

        for (var i = 0; i < data.length; i++) {
            if (data[i] >= maxConsumption) {
                filteredData.push(data[i]);
                filteredLabels.push(labels[i]);
            }
        }

        // Päivitä kaavion data ja labelit
        var ctx = document.getElementById("myChart").getContext("2d");
        myChart.data.labels = filteredLabels;
        myChart.data.datasets[0].data = filteredData;
        myChart.update({
            animation: {
                duration: 1000,
                easing: 'easeInOutBounce'
            }
        });
    }


    document.getElementById("filterButton").addEventListener("click", updateFilteredChart);

    function updateFilteredChart1() {
        var maxConsumption = Math.min(...data) * 0;

        var filteredData = [];
        var filteredLabels = [];

        for (var i = 0; i < data.length; i++) {
            if (data[i] >= maxConsumption) {
                filteredData.push(data[i]);
                filteredLabels.push(labels[i]);
            }
        }

        // Päivitä kaavion data ja labelit
        var ctx = document.getElementById("myChart").getContext("2d");
        myChart.data.labels = filteredLabels;
        myChart.data.datasets[0].data = filteredData;
        myChart.update({
            animation: {
                duration: 1000,
                easing: 'easeInOutBounce'
            }
        });
    }

    document.getElementById("filterButton1").addEventListener("click", updateFilteredChart1);

    function updateFilteredChart2() {
        // Laske noin 70% kulutus
        var avgConsumption = data.reduce((a, b) => a + b, 0) / data.length;

        var filteredData = [];
        var filteredLabels = [];

        for (var i = 0; i < data.length; i++) {
            if (data[i] <= avgConsumption) {
                filteredData.push(data[i]);
                filteredLabels.push(labels[i]);
            }
        }

        // Päivitä kaavion data ja labelit
        var ctx = document.getElementById("myChart").getContext("2d");
        myChart.data.labels = filteredLabels;
        myChart.data.datasets[0].data = filteredData;
        myChart.update({
            animation: {
                duration: 1000,
                easing: 'easeInOutBounce'
            }
        });
    }

    document.getElementById("filterButton2").addEventListener("click", updateFilteredChart2);
    function calculateYearlyConsumption(data) {
        // Lasketaan käytettävissä olevien tuntien määrä
        var availableHours = data.length;

        // Oletetaan, että vuodessa on 8760 tuntia (365 päivää x 24 tuntia)
        var totalHoursInYear = 8760;

        // Lasketaan karkea odotettu vuosikulutus
        var yearlyConsumption = (data.reduce((a, b) => a + b, 0) / availableHours) * totalHoursInYear;

        // Palautetaan vuosikulutus
        return yearlyConsumption;
    }

</script>



<input type="file" id="fileUpload" />
<button class="button button2" onclick="Upload()">Lataa tiedosto</button>
</div>


<div class="container2">
    <div id="dvCSV"></div>
    <canvas id="myChart" width="650" height="450"></canvas>
    <div class="button-container hidden" id="buttonContainer">
    <button id="filterButton" class="button button2" onclick="updateFilteredChart()">Kulutuspiikit</button>
    <button id="filterButton1" class="button button2" onclick="updateFilteredChart1()">Kaikki</button>
    <button id="filterButton2" class="button button2" onclick="updateFilteredChart2()">Peruskulutus</button>
</div>
</div>


<div id="sidebar" style="display: none; justify-content: space-between; flex-direction: row;">
    <h2>Sähkölaitteiden keskivertokulutus vuodessa</h2>
    <button class="button button1"> Kylmälaitteet 430kWh</button>
    <button class="button button7"> Kodin elektroniikka 390kWh </button>
    <button class="button button3"> Ruoan valmistus ja astianpesu 250kWh </button>
    <button class="button button4"> Valaistus 170kWh</button>
    <button class="button button5"> Pyykinpesu 80kWh</button>
    <button class="button button6"> Muu 80kWh</button>
</div>

</div>

<div id="surveyModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSurveyModal()">&times;</span>
        <h2>Kysely</h2>
        <!-- Tähän voit lisätä kyselyn kysymykset. -->
        <p>Kysymys 1</p>
        <p>Kysymys 2</p>
        <p>Kysymys 3</p>
        <!-- Lisää painike, jolla käyttäjä voi lähettää kyselyn -->
        <button onclick="submitSurvey()">Lähetä</button>
    </div>
</div>


<p id="surveyPrompt" style="display: none;">Vastaa kyselyyn, jotta saat enemmän tietoa kulutuksestasi.</p>
<button id="surveyButton" class="button button2" onclick="openSurveyModal()" style="display: none;">Vastaa kyselyyn</button>

<script>
function openSurveyModal() {
document.getElementById("surveyModal").style.display = "block";
}

function closeSurveyModal() {
document.getElementById("surveyModal").style.display = "none";
}

function submitSurvey() {
// Tähän voit lisätä koodin, joka käsittelee kyselyn lähettämisen.
closeSurveyModal();
}
</script>


</html>